integration_methods = """ {"Invoicing" :{"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["invoicing","standard pp.com invoicing"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },"Payouts" :{"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["payouts","mass pay"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           }, 
                           "Other Branded" : 
                          {"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["other branded"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                           "Express Checkout" : 
                          {"One-Click" : {"cart" : ["BigCommerce","Shopify","Magento"],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : ["BigCommerce","Magento","Shopify","WooCommerce"],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : ["Magento","WooCommerce"],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["express checkout"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                            "ACDC" : 
                          {"One-Click" : {"cart" : ["Magento"],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : ["Shopify","Magento","WooCommerce","Yahoo"],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : ["Shopify","Magento","WooCommerce","Yahoo"],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["acdc"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                            "Marketplace" : 
                          {"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : ["Shopify","Magento","WooCommerce"],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : ["Shopify","Magento","WooCommerce"],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["marketplace"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                           "Gateway Only" : 
                          {"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                              "product" : ["gateway only"],                                                      
                                              "method" : [],                                                      
                                              "type" : []}
                           },
                           "Braintree" : 
                          {"One-Click" : {"cart" : ["BigCommerce", "Magento","Angelleye","Zencart",
                                                   "CartHook","OpenCart","Wix","X-cart"],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : ["BigCommerce", "Magento","Shopify","3dcart",
                                                        "Shift4Shop","Zencart","CartHook","Miva","OpenCart"
                                                       ,"SF Commerce Cloud","Wix","X-cart"],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : ["Magento","Shopify","3dcart",
                                                        "Shift4Shop","Zencart","CartHook","Miva","OpenCart",
                                                         "SF Commerce Cloud","Wix","X-cart","SAP-Hybris",
                                                         "Oracle-BDS","IBM Websphere"],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : ["IBM-Sterling","Microsoft"],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["braintree"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                           "Braintree Enterprise In-Store" : 
                          {"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["braintree enterprise in-store"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           },
                           "Hyperwallet" : 
                          {"One-Click" : {"cart" : [],
                                          "product" : [],
                                          "method" : [],
                                          "type" : []},
                           "Partner-Low" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Partner-High" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "Direct Bespoke" : {"cart" : [],                                                      
                                               "product" : [],                                                      
                                               "method" : [],                                                      
                                               "type" : []},
                           "via BT" : {"cart" : [],                                                      
                                       "product" : [],                                                      
                                       "method" : [],                                                      
                                       "type" : []},
                           "via PPCP" : {"cart" : [],                                                      
                                         "product" : [],                                                      
                                         "method" : [],                                                      
                                         "type" : []},
                           "Known Other" : {"cart" : [],                                                      
                                              "product" : [],                                                      
                                              "method" : [],                                                      
                                              "type" : []},
                           "Unknown" : {"cart" : [],                                                      
                                        "product" : ["hyperwallet"],                                                      
                                        "method" : [],                                                      
                                        "type" : []}
                           }
                           }
"""

Product_intrgn_mthd = json.loads(integration_methods)

# Existing and Target Product categories and Family Matrices
lin_dict = dict()
prod_lvl2_ls = []
prod_lvl1_ls = []

for k,v in Product_intrgn_mthd.items():
    prod_lvl1_ls.append(k.lower())
    for k1,v1 in v.items():
        prod_lvl2_ls.append(k1.lower())
        for k2,v2 in v1.items():
            for v3 in v2:
                lin_dict[v3.lower()] = k.lower()+';'+k1.lower()

lvl2_ls = list(set(prod_lvl2_ls))
lvl1_ls = list(set(prod_lvl1_ls))
                
lvl2_dict = dict()
lvl1_dict = dict()
for i,v in enumerate(lvl2_ls):
    lvl2_dict[v] = i

for i,v in enumerate(lvl1_ls):
    lvl1_dict[v] = i
    
prod_matrics = [[0]*len(lvl2_dict) for _ in range(len(lvl1_dict))]
col_order = [v[0] for v in sorted(lvl2_dict.items(), key=lambda kv: (kv[1], kv[0]))]
row_order = [v[0] for v in sorted(lvl1_dict.items(), key=lambda kv: (kv[1], kv[0]))]


def set_tgt(col,n):
    if col == None:
        return None
    elif col.lower() in lin_dict.keys():
        return lin_dict[col.lower()].split(';')[n]
    else:
        return None

final_matrics_ls = dict()
def index_ident_mat_upd(sf_acct_id,col_ls,tbl_nm):
    prod_matrics = [[0]*len(lvl2_dict) for _ in range(len(lvl1_dict))]
    for kv in col_ls:
        r = None
        c = None
        if kv == None:
            continue
        else:
            col2 = list(kv.values())[0]
            col1 = list(kv.keys())[0]
            if col2 == None:
                continue
            elif col2 in lvl2_dict.keys():
                c = lvl2_dict[col2]
    
            if col1 == None:
                continue
            elif col1 in lvl1_dict.keys():
                r = lvl1_dict[col1]
            
            if r != None and c != None:
                prod_matrics[r][c] = prod_matrics[r][c] + 1
    
    interim_matrics_df = pd.DataFrame(prod_matrics,columns=col_order)
    interim_matrics_df['products'] = row_order
    globals()[tbl_nm+str(sf_acct_id)] = interim_matrics_df.set_index('products')
    return 'done'
    


def ni_compute(sf_acct_id,tgt,exst):
    temp_ni_matrics = [[0]*len(ni_columns.keys()) for _ in range(len(ni_rows.keys()))]
    if tgt is None or isinstance(tgt,float):
        return 0
    elif exst is None or isinstance(exst,float):
        for kv in tgt:
            r = None
            c = None
            
            if list(kv.keys())[0] in ni_rows.keys():
                r = ni_rows[list(kv.keys())[0]]
               
            if list(kv.values())[0] in ni_columns.keys():
                c = ni_columns[list(kv.values())[0]]
               
            if c == None:
                c = ni_columns['unknown']
            
            if r != None and c != None:
                temp_ni_matrics[r][c] = temp_ni_matrics[r][c] + int(ni_matrics[r][c]) 
    
    
    else: #new addition
        for kv in tgt:
            r = None
            c = None
            print("kv",kv)

            if kv.keys() is None:
                return 0

            else:
                for key_tgt in kv.keys():
                    for key_exst_dict in exst:
                        for key_exst in key_exst_dict.keys():
                            if key_exst == key_tgt:
                                return 0
                            else:
                                if list(kv.keys())[0] in ni_rows.keys():
                                    r = ni_rows[list(kv.keys())[0]]
                                    print("r",r)

                                if list(kv.values())[0] in ni_columns.keys():
                                    c = ni_columns[list(kv.values())[0]]
                                    print("c",c)

                                if c == None:
                                    c = ni_columns['unknown']

                                if r != None and c != None:
                                    temp_ni_matrics[r][c] = temp_ni_matrics[r][c] + int(ni_matrics[r][c])

                            ni_interim_matrics_df = pd.DataFrame(temp_ni_matrics,columns=ni_col_order)
                            ni_interim_matrics_df['products'] = ni_row_order
                            globals()['ni_'+str(sf_acct_id)] = ni_interim_matrics_df.set_index('products')
                            return sum(map(sum, temp_ni_matrics))